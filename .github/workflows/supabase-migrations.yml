name: Supabase Auto Sync

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: supabase-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  plan:
    # Ce job s’exécute uniquement sur les PR (ne modifie rien en base)
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Guard: DB changée => migration requise"
        run: |
          set -e
          RANGE="origin/${{ github.base_ref }}...${{ github.sha }}"
          echo "Diff range: $RANGE"
          CHANGED="$(git diff --name-only $RANGE || true)"
          echo "$CHANGED" | sed 's/^/ - /'
          CHANGED_DB="$(echo "$CHANGED" | grep -E '^supabase/' | grep -vE '^supabase/migrations/' || true)"
          HAS_MIG="$(echo "$CHANGED" | grep -E '^supabase/migrations/.*\.sql$' || true)"
          if [ -n "$CHANGED_DB" ] && [ -z "$HAS_MIG" ]; then
            echo '❌ Des fichiers DB ont changé sans migration SQL (supabase/migrations/*.sql).'
            exit 1
          fi
          echo '✅ Garde-fou OK : aucune infraction.'

      - name: "Setup Supabase CLI"
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: "Plan (dry-run)"
        run: |
          set -e
          supabase db push \
            --db-url "${SUPABASE_DB_URL}" \
            --workdir ./supabase \
            --dry-run

  sync:
    # Applique réellement après merge/push sur main
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Guard: DB changée => migration requise"
        run: |
          set -e
          RANGE="${{ github.event.before }}...${{ github.sha }}"
          echo "Diff range: $RANGE"
          CHANGED="$(git diff --name-only $RANGE || true)"
          echo "$CHANGED" | sed 's/^/ - /'
          CHANGED_DB="$(echo "$CHANGED" | grep -E '^supabase/' | grep -vE '^supabase/migrations/' || true)"
          HAS_MIG="$(echo "$CHANGED" | grep -E '^supabase/migrations/.*\.sql$' || true)"
          if [ -n "$CHANGED_DB" ] && [ -z "$HAS_MIG" ]; then
            echo '❌ Des fichiers DB ont changé sans migration SQL (supabase/migrations/*.sql).'
            exit 1
          fi
          echo '✅ Garde-fou OK : aucune infraction.'

      - name: "Setup Supabase CLI"
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: "Apply migrations (idempotent)"
        run: |
          set -e
          supabase db push \
            --db-url "${SUPABASE_DB_URL}" \
            --workdir ./supabase \
            --include-all \
            --yes
